<!DOCTYPE html>
<html>
    <head>
        <title>Molecule Render</title>
        <script src="js/lib/three.js"></script>
        <script src="js/lib/TrackballControls.js"></script>
        <script src="js/lib/stats.min.js"></script>
        <script src="js/lib/jquery-1.11.1.js"></script>
        
        <script src="js/src/CPK.js"></script>       
        <script src="js/src/MoleculeStructures.js"></script>
        <script src="js/src/Renderer.js"></script>

        <script src="samples/1ZEH.js"></script>
        <style>
            #drawDiv {
                height:100%;
                width:100%; 
                margin:0;
                padding:0;
                
                background-color: #CCCCCC;
            }
            html, body, table {
                height:100%;
                width:100%;
                margin:0;
                padding:0;
                border-collapse: collapse;
            }

            #header {
                text-decoration: underline;
                font-size:20px;                
            }

            #preferenceDiv {
                margin: 5px 5px 5px 5px;
                border:1px solid black;
                border-radius: 5px;
                padding: 10px;
            }

        </style>
        <script>
            SERVER_ADDR = 'http://localhost:5000/'
        </script>

    </head>
    <body onload="init();">
        <table>
            <td style="vertical-align:top; width:200px;">    
                <div id='preferenceDiv'>            
                    <div id='header'>Загрузите молекулу:</div>
                    Введите SMILES: <br />
                    <input type="text" name="smiles" id="smiles"> <br />
                    Или выберите файл: <br />
                    <input type="file" name="uploadFile" id="uploadFile"/> <br />
                    <input type="button" value="Отрисовать" id="loadButton" onclick="getNewMoleculeAndDraw()" disabled/> <br />
                </div>
                <div id='preferenceDiv'>            
                    <div id='header'>Настройки:</div>
                    Режим <select name='mode' id='modeChecker'>
                        <option selected="selected" value="ribbon">ribbon</option>
                        <option value="balls">balls</option>
                        <option value="lightBonds">lightBonds</option>
                        <option value="bonds">bonds</option>                       
                        <option value="ballsAndBonds">balls & bonds</option>
                    </select> <br />
                    Качество <select name='quality' id='qualityChecker'>
                        <option value="high">high</option>
                        <option value="medium">medium</option>
                        <option selected="selected" value="low">low</option>
                        </select> <br />
                    <!--checked="checked"-->
                    Включить сглаживание <input type="checkbox" name='antialiasFlag' id='antialiasFlagChecker'> 
                    <input type="submit" onClick="setProperty(); buildSceneAndDraw(molecule);" value="Применить">            
                </div>
            </td>
            <td style="padding:0;">
                <div id='drawDiv'></div>
            </td>
        </table>

        <script type="text/javaScript">
            var molecule;
            var mode;
            var quality;
            var antialiasFlag;

            function init() {
                setProperty();
                drawPDBMolecule(pdb1ZEH);
            }

            function setProperty() {
                mode = document.getElementById("modeChecker").value;
                quality = document.getElementById("qualityChecker").value;
                antialiasFlag = document.getElementById("antialiasFlagChecker").checked;
                console.log('set property', mode, quality, antialiasFlag);
            }

            function getNewMoleculeAndDraw(){
                setLoadButtonDisabled(true); 
                var uploadFile = document.getElementById ("uploadFile");
                var smiles = document.getElementById ("smiles");

                if (smiles.value.length != 0) {
                    drawMolecule('smi', smiles.value);
                } else if (uploadFile.value.length != 0) {
                    var r = new FileReader();
                    f = uploadFile.files[0];

                    r.onload = function(e) { 
                        var file = e.target.result;
                        drawMolecule(getSuffix(f.name), file);
                    }

                    r.readAsText(f);
                } else {
                    alert('Вы должны ввести SMILES или выбрать файл');
                    setLoadButtonDisabled(false);; 
                }
            }

            function drawMolecule(type, data) {
                if (type == 'pdb') {
                   drawPDBMolecule(data);
                } else {
                    convertMoleculeAndDraw(type, data);
                }
            }

            function getSuffix(filename) {
                return filename.split('.').pop();
            }

            function convertMoleculeAndDraw(file_type, file) {
                $.post(SERVER_ADDR,{
                    type: file_type,
                    data: file
                }).success(function(data, textStatus) {
                    if (data.substr(0,5) != 'ERROR')
                        drawPDBMolecule(data);

                    else {
                        alert('Ошибка сервера.\n' + data);
                        setLoadButtonDisabled(false);
                    }

                }).error(function() {                         
                    alert("Ошибка подключения к серверу");
                    setLoadButtonDisabled(false);

                });
            }

            function drawPDBMolecule(data) {
                molecule = new Molecule();
                molecule.parsePDBFile(data);
                molecule.moveToCenter();        

                buildSceneAndDraw(molecule);
                animate();

                setLoadButtonDisabled(false);
            }

            function setLoadButtonDisabled(disabled) {
                document.getElementById("loadButton").disabled = disabled;
            }
        </script>
    </body>
</html>
